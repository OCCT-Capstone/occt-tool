<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta & head -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCCT – Dashboard</title>

  <!-- Global site helpers (exposes window.occt.api) -->
  <script src="{{ url_for('static', filename='js/site.js') }}"></script>

  <!-- Favicon & global styles (served by Flask static) -->
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='assets/occt-logo.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body class="dash-body">

  <!-- ========== Top Navigation ========== -->
  <nav class="topbar">
    <div class="brand">OCCT</div>
    <ul class="navlinks">
      <li class="active"><a href="/">Dashboard</a></li>
      <li><a href="/audit">Audit</a></li>
      <li><a href="/remediation">Remediation</a></li>
      <li><a href="/settings">Settings</a></li>
    </ul>
  </nav>

  <!-- ========== Main Content ========== -->
  <main class="container">

    <!-- ===== KPI Row (3 cards) ===== -->
    <section class="grid grid-3">
      <!-- Compliance Status (Donut) -->
      <div class="card">
        <h3>Compliance Status</h3>

        <!-- Donut chart (SVG) -->
        <div class="donut-wrap">
          <svg class="donut" viewBox="0 0 36 36" aria-label="Donut chart">
            <!-- Track -->
            <path
              class="donut-track"
              d="M18 2 a 16 16 0 1 1 0 32 a 16 16 0 1 1 0 -32"
            />
            <!-- Value (dasharray updated via JS) -->
            <path
              id="donut-value"
              class="donut-value"
              stroke-dasharray="0, 100"
              d="M18 2 a 16 16 0 1 1 0 32 a 16 16 0 1 1 0 -32"
            />
            <!-- Cap (visual end point) -->
            <circle class="donut-cap" cx="18" cy="2" r="1.1"></circle>
          </svg>

          <!-- Donut center content -->
          <div class="donut-center">
            <div class="donut-number" id="nonCompliantPct">—</div>
            <div class="donut-sub">Non-Compliant</div>
          </div>
        </div>
      </div>

      <!-- Audit Checks (numeric KPIs) -->
      <div class="card">
        <h3>Audit Checks</h3>
        <div class="kpi-big" id="kpiTotal">—</div>
        <div class="kpi-row">
          <span class="muted">Passed</span><span id="kpiPassed">—</span>
        </div>
        <div class="kpi-row">
          <span class="muted">Failed</span><span id="kpiFailed">—</span>
        </div>
      </div>

      <!-- Account Activity (numeric KPIs) -->
      <div class="card">
        <h3>Account Activity</h3>
        <div class="kpi-big" id="kpiIssues">—</div>
        <div class="kpi-row">
          <span class="muted">Issues Detected</span><span id="kpiIssuesDetail">—</span>
        </div>
        <div class="kpi-row">
          <span class="muted">Accounts</span><span id="kpiAccounts">—</span>
        </div>
      </div>
    </section>

    <!-- ===== Charts / Log Row (2 cards) ===== -->
    <section class="grid grid-2">
      <!-- Compliance Over Time (bars) -->
      <div class="card">
        <h3>Compliance Over Time</h3>

        <!-- Simple legend -->
        <div class="legend">
          <span class="key key-green"></span> Compliant
          <span class="spacer"></span>
          <span class="key key-red"></span> Non-Compliant
        </div>

        <!-- Bars placeholder; JS injects columns -->
        <div class="bars" id="barChart"></div>

        <!-- X-axis labels (populated from data) -->
        <div class="axis-x" id="axisX"></div>
      </div>

      <!-- Audit Log (preview) -->
      <div class="card">
        <h3>Audit Log</h3>

        <!-- Container JS will fill -->
        <div class="table" id="auditPreview"></div>

        <!-- Link to full audit page -->
        <a class="link" href="/audit">See all</a>
      </div>
    </section>

  </main>

  <!-- ========== Page Scripts (local-only, no external deps) ========== -->
  <script>
    (async () => {
      // ---------- Helpers ----------
      const api = (window.occt && window.occt.api)
        ? window.occt.api
        : (p => '/api/sample' + p); // fallback to samples if site.js not present

      function escapeHTML(s = '') {
        return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
      }
      function fmtTime(iso) {
        if (!iso) return '';
        const d = new Date(iso);
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
      function badgeClass(cat) {
        return cat === 'System' ? 'sys' : cat === 'Security' ? 'sec' : 'acc';
      }

      // ---------- Fetch both dashboard + audit preview ----------
      try {
        const [dashRes, auditRes] = await Promise.all([
          fetch(api('/dashboard')),
          fetch(api('/audit'))
        ]);
        if (!dashRes.ok)  throw new Error('Dashboard HTTP ' + dashRes.status);
        if (!auditRes.ok) throw new Error('Audit HTTP ' + auditRes.status);

        const dash  = await dashRes.json();
        const audit = await auditRes.json();

        // ===== Donut =====
        const pct = Number(dash?.summary?.non_compliant_percent ?? 0);
        document.getElementById('donut-value')
          .setAttribute('stroke-dasharray', `${pct}, 100`);
        document.getElementById('nonCompliantPct').textContent = `${pct}%`;

        // ===== Bars =====
        const monthly = Array.isArray(dash?.monthly) ? dash.monthly : [];
        const barChart = document.getElementById('barChart');
        const axisX = document.getElementById('axisX');
        barChart.innerHTML = '';
        axisX.innerHTML = '';

        monthly.forEach(pt => {
          const col = document.createElement('div');
          col.className = 'barcol';

          const green = document.createElement('div');
          green.className = 'bar green';
          green.style.height = (Number(pt.compliant) || 0) + '%';

          const red = document.createElement('div');
          red.className = 'bar red';
          red.style.height = (Number(pt.noncompliant) || 0) + '%';

          col.appendChild(green);
          col.appendChild(red);
          barChart.appendChild(col);

          const tick = document.createElement('span');
          tick.textContent = pt.month || '';
          axisX.appendChild(tick);
        });

        // ===== KPIs (optional demo values using audit list) =====
        // You can replace this with real totals from your backend when available.
        const total = Array.isArray(audit) ? audit.length : 0;
        const passed = Array.isArray(audit) ? audit.filter(r => r.outcome === 'Passed').length : 0;
        const failed = total - passed;

        document.getElementById('kpiTotal').textContent = total || '—';
        document.getElementById('kpiPassed').textContent = passed || '0';
        document.getElementById('kpiFailed').textContent = failed || '0';
        document.getElementById('kpiIssues').textContent = failed || '0';
        document.getElementById('kpiIssuesDetail').textContent = failed ? String(failed) : '0';
        // If you track distinct accounts, set kpiAccounts accordingly
        const accounts = Array.isArray(audit)
          ? new Set(audit.map(r => r.account).filter(Boolean)).size
          : 0;
        document.getElementById('kpiAccounts').textContent = accounts || '—';

        // ===== Audit preview (top 5 rows) =====
        const preview = document.getElementById('auditPreview');
        const top = (Array.isArray(audit) ? audit : []).slice(0, 5);

        preview.innerHTML = `
          <div class="thead">
            <div>Time</div><div>Category</div><div>Description</div>
          </div>
          ${top.map(r => `
            <div class="trow">
              <div>${fmtTime(r.time)}</div>
              <div><span class="badge ${badgeClass(r.category)}">${escapeHTML(r.category || '')}</span></div>
              <div>${escapeHTML(r.description || '')}</div>
            </div>
          `).join('')}
        `;
      } catch (err) {
        console.error('Dashboard load failed:', err);
        // Minimal fallback so the page still looks okay
        document.getElementById('nonCompliantPct').textContent = '—';
      }
    })();
  </script>
</body>
</html>
